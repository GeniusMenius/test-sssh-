#!/bin/bash
set -e

GLANCES_PORT="61209"

echo ">>> Installing Glances Prometheus exporter (binds to ALL IPs)"

# --- REMOVE existing Glances ---
echo ">>> Removing old Glances installations..."
systemctl stop glances 2>/dev/null || true
systemctl disable glances 2>/dev/null || true
rm -f /etc/systemd/system/glances.service
rm -f /etc/systemd/system/glances-exporter.service
rm -rf /opt/glances

if [ -f /etc/init.d/glances ]; then
    rc-service glances stop || true
    rm -f /etc/init.d/glances
fi

# --- DETECT OS ---
OS="$(awk -F= '/^ID=/{print $2}' /etc/os-release | tr -d '"')"
echo ">>> Detected OS: $OS"

# --- INSTALL DEPENDENCIES ---
if [[ "$OS" == "debian" || "$OS" == "ubuntu" ]]; then
    apt update
    apt install -y python3 python3-venv python3-pip curl git
elif [[ "$OS" == "alpine" ]]; then
    apk update
    apk add python3 py3-pip py3-virtualenv curl git
else
    echo "Unsupported OS: $OS"
    exit 1
fi

# --- CREATE virtualenv ---
echo ">>> Setting up virtualenv..."
mkdir -p /opt/glances
python3 -m venv /opt/glances/.venv
/opt/glances/.venv/bin/pip install --upgrade pip setuptools wheel
/opt/glances/.venv/bin/pip install glances

# --- CREATE SYSTEMD SERVICE (exporter only) ---
echo ">>> Creating systemd service for Prometheus exporter..."
cat <<EOF > /etc/systemd/system/glances-exporter.service
[Unit]
Description=Glances Prometheus Exporter
After=network.target

[Service]
Type=simple
ExecStart=/opt/glances/.venv/bin/glances --export prometheus -B 0.0.0.0 -p ${GLANCES_PORT}
Restart=on-failure
WorkingDirectory=/opt/glances
User=root

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable glances-exporter
systemctl restart glances-exporter

echo ""
echo ">>> Glances Prometheus exporter is now running on port ${GLANCES_PORT}"
echo ""

# --- LIST ALL IP ADDRESSES ---
echo ">>> Listing all IP addresses on this host:"
IP_LIST=$(hostname -I)

for ip in $IP_LIST; do
    echo " - http://${ip}:${GLANCES_PORT}/metrics"
done

echo ""
echo ">>> You can use ANY of these IPs as Prometheus targets."
echo ">>> Installation complete."
