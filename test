#!/bin/bash
set -e

# Ange IP-adress som Glances ska bindas till
GLANCES_IP="${1:-$(hostname -I | awk '{print $1}')}"
GLANCES_PORT="${2:-61208}"

echo ">>> Installing Glances with Prometheus exporter on ${GLANCES_IP}:${GLANCES_PORT}"

# --- REMOVE existing Glances ---
echo ">>> Removing old Glances installations..."
if command -v systemctl &>/dev/null; then
    systemctl stop glances || true
    systemctl disable glances || true
    rm -f /etc/systemd/system/glances.service
elif command -v rc-service &>/dev/null; then
    rc-service glances stop || true
    rm -f /etc/init.d/glances
fi
rm -rf /opt/glances

# --- DETECT OS ---
OS="$(awk -F= '/^ID=/{print $2}' /etc/os-release | tr -d '"')"
echo ">>> Detected OS: $OS"

# --- INSTALL DEPENDENCIES ---
if [[ "$OS" == "debian" || "$OS" == "ubuntu" ]]; then
    echo ">>> Fixing broken packages..."
    dpkg --configure -a || true
    apt --fix-broken install -y || true
    apt update
    apt install -y python3 python3-venv python3-pip curl git || true
elif [[ "$OS" == "alpine" ]]; then
    apk update
    apk add python3 py3-pip py3-virtualenv curl git
else
    echo "Unsupported OS: $OS"
    exit 1
fi

# --- CREATE virtualenv ---
echo ">>> Setting up virtualenv..."
mkdir -p /opt/glances
python3 -m venv /opt/glances/.venv
/opt/glances/.venv/bin/pip install --upgrade pip setuptools
/opt/glances/.venv/bin/pip install glances[all]

# --- CREATE SERVICE ---
if command -v systemctl &>/dev/null; then
    echo ">>> Creating systemd service..."
    cat <<EOF > /etc/systemd/system/glances.service
[Unit]
Description=Glances - An eye on your system
After=network.target

[Service]
Type=simple
ExecStart=/opt/glances/.venv/bin/glances -w --export prometheus -B ${GLANCES_IP} -p ${GLANCES_PORT}
Restart=on-failure
WorkingDirectory=/opt/glances

[Install]
WantedBy=multi-user.target
EOF
    systemctl daemon-reload
    systemctl enable glances
    systemctl restart glances
elif command -v rc-service &>/dev/null; then
    echo ">>> Creating OpenRC service..."
    cat <<EOF > /etc/init.d/glances
#!/sbin/openrc-run

command="/opt/glances/.venv/bin/glances"
command_args="-w --export prometheus -B ${GLANCES_IP} -p ${GLANCES_PORT}"
command_background="yes"

depend() {
    need net
}

description="Glances system monitoring with Prometheus exporter"
EOF
    chmod +x /etc/init.d/glances
    rc-update add glances default
    rc-service glances start
fi

echo ">>> Glances installed and running at http://${GLANCES_IP}:${GLANCES_PORT}/metrics"
