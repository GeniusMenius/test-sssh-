#!/bin/bash
set -e

# Ange IP-adress som Glances ska bindas till
GLANCES_IP="${1:-$(hostname -I | awk '{print $1}')}"
GLANCES_PORT="${2:-61208}"

echo ">>> Installing Glances with Prometheus exporter on ${GLANCES_IP}:${GLANCES_PORT}"

# --- REMOVE existing Glances ---
echo ">>> Removing old Glances installations..."
if command -v systemctl &>/dev/null; then
    sudo systemctl stop glances || true
    sudo systemctl disable glances || true
    sudo rm -f /etc/systemd/system/glances.service
elif command -v rc-service &>/dev/null; then
    sudo rc-service glances stop || true
    sudo rm -f /etc/init.d/glances
fi
sudo rm -rf /opt/glances

# --- INSTALL dependencies ---
OS="$(awk -F= '/^ID=/{print $2}' /etc/os-release | tr -d '"')"
echo ">>> Detected OS: $OS"

if [[ "$OS" == "debian" || "$OS" == "ubuntu" ]]; then
    sudo apt update
    sudo apt install -y python3 python3-venv python3-pip curl git
elif [[ "$OS" == "alpine" ]]; then
    sudo apk update
    sudo apk add python3 py3-pip py3-virtualenv curl git
else
    echo "Unsupported OS: $OS"
    exit 1
fi

# --- CREATE virtualenv ---
echo ">>> Setting up virtualenv..."
sudo mkdir -p /opt/glances
sudo python3 -m venv /opt/glances/.venv
sudo /opt/glances/.venv/bin/pip install --upgrade pip setuptools
sudo /opt/glances/.venv/bin/pip install glances[all]

# --- CREATE SERVICE ---
if command -v systemctl &>/dev/null; then
    echo ">>> Creating systemd service..."
    cat <<EOF | sudo tee /etc/systemd/system/glances.service
[Unit]
Description=Glances - An eye on your system
After=network.target

[Service]
Type=simple
ExecStart=/opt/glances/.venv/bin/glances -w --export prometheus -B ${GLANCES_IP} -p ${GLANCES_PORT}
Restart=on-failure
WorkingDirectory=/opt/glances

[Install]
WantedBy=multi-user.target
EOF

    sudo systemctl daemon-reload
    sudo systemctl enable glances
    sudo systemctl restart glances
elif command -v rc-service &>/dev/null; then
    echo ">>> Creating OpenRC service..."
    cat <<EOF | sudo tee /etc/init.d/glances
#!/sbin/openrc-run

command="/opt/glances/.venv/bin/glances"
command_args="-w --export prometheus -B ${GLANCES_IP} -p ${GLANCES_PORT}"
command_background="yes"

depend() {
    need net
}

description="Glances system monitoring with Prometheus exporter"
EOF
    sudo chmod +x /etc/init.d/glances
    sudo rc-update add glances default
    sudo rc-service glances restart
fi

echo ">>> Glances installed and running at http://${GLANCES_IP}:${GLANCES_PORT}/metrics"
